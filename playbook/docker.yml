---
- name: Install Docker
  hosts: servers
  become: true
  tasks:
  - name: Install aptitude
    apt:
      name: aptitude
      state: latest
      update_cache: true
  - name: Install required system packages
    apt:
      pkg:
        - apt-transport-https
        - ca-certificates
        - curl
        - software-properties-common
        - python3-pip
        - python3-setuptools
      state: latest
      update_cache: true
  - name: Add Docker GPG apt key
    apt_key:
      url: https://download.docker.com/linux/ubuntu/gpg
      state: present
  - name: Add Docker Repository
    apt_repository:
      repo: deb https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable
      state: present
  - name: Update apt and install docker-ce
    apt:
      name: docker-ce
      state: latest
      update_cache: true
  - name: Configure daemon.json
    copy:
      dest: /etc/docker/daemon.json
      content: |
        {
          "metrics-addr" : "0.0.0.0:9323"
        }
    register: daemon_config
  - name: Install Docker Module for Python
    pip:
      name:
        - docker
        - jsondiff
  - name: Restart Docker service
    service:
      name: docker
      state: restarted
    when: daemon_config.changed
